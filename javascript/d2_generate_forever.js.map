{"version":3,"file":"d2_generate_forever.js","sources":["../src/js/D2GFCounter.ts","../src/js/D2GFGenerateForever.ts","../src/js/index.ts"],"sourcesContent":["/* global gradioApp */\r\nimport { TType } from './types';\r\n\r\ndeclare var gradioApp: any;\r\n\r\nclass D2GFCounter {\r\n    type: TType;\r\n    countArea: HTMLElement | undefined;\r\n    batchArea: HTMLElement | undefined;\r\n    batchCountInput: HTMLInputElement | undefined;\r\n    batchCountText: string = '';\r\n    count = 0;\r\n\r\n    /**\r\n     * コンストラクタ\r\n     *\r\n     * @param type txt2img / img2img\r\n     * @param onChangeCount カウンタ更新時に実行する関数\r\n     */\r\n    constructor(type: TType) {\r\n        this.type = type;\r\n    }\r\n\r\n    createContainer(): HTMLElement {\r\n        const app = gradioApp();\r\n\r\n        const container = document.createElement('span');\r\n        container.id = `d2gf-count-container_${this.type}`;\r\n\r\n        this.countArea = document.createElement('span');\r\n        this.countArea.classList.add('d2gf-count-area');\r\n\r\n        this.batchArea = document.createElement('span');\r\n        container.appendChild(this.countArea);\r\n        container.appendChild(this.batchArea);\r\n\r\n        // バッチカウントエレメント\r\n        this.batchCountInput = app.querySelector(`#${this.type}_batch_count input`) as HTMLInputElement;\r\n\r\n        return container;\r\n    }\r\n\r\n    /**\r\n     * webui の batch count の値を取得して返す\r\n     * 表示欄も更新する\r\n     * 1だったら∞マークにする\r\n     * @returns\r\n     */\r\n    getBatchCount(): number {\r\n        const batchCountInput = this.batchCountInput as HTMLInputElement;\r\n        if (this.batchArea) {\r\n            this.batchCountText = `${batchCountInput.value === '1' ? '∞' : batchCountInput.value}`;\r\n            this.batchArea.textContent = this.batchCountText;\r\n        }\r\n        return parseInt(batchCountInput.value);\r\n    }\r\n\r\n    resetCount() {\r\n        this.$_setCount(0);\r\n    }\r\n\r\n    addCount() {\r\n        this.$_setCount(this.count + 1);\r\n    }\r\n\r\n    /**\r\n     * 生成カウンタをセット\r\n     */\r\n    private $_setCount(count: number) {\r\n        this.count = count;\r\n\r\n        if (this.countArea) {\r\n            this.countArea.textContent = `${count}`;\r\n        }\r\n    }\r\n}\r\n\r\nexport { D2GFCounter };\r\n","/* global gradioApp */\r\nimport { D2GFCounter } from './D2GFCounter';\r\nimport { TType, TStateAttr, TStateVal, TStateDict, TOption } from './types';\r\n\r\ndeclare var gradioApp: any;\r\ndeclare var opts: TOption;\r\n\r\nconst SEED_INTERVAL = 1000;\r\n\r\nclass D2GFGenerateForever {\r\n    foreverBtn: HTMLButtonElement | undefined;\r\n    cancelBtn: HTMLButtonElement | undefined;\r\n\r\n    type: TType;\r\n    state: TStateDict;\r\n    counter: D2GFCounter;\r\n    generateCount = 0;\r\n    pageTitle: string;\r\n\r\n    /**\r\n     * コンストラクタ\r\n     * @param {*} type txt2img / img2img\r\n     */\r\n    constructor(type: TType) {\r\n        this.type = type;\r\n        this.state = {\r\n            forever: 'stop',\r\n            seed: 'random',\r\n        };\r\n        this.generateCount = 0;\r\n        this.counter = new D2GFCounter(type);\r\n        this.pageTitle = document.title;\r\n    }\r\n\r\n    /**\r\n     * 初期化\r\n     */\r\n    init() {\r\n        this.createControl();\r\n    }\r\n\r\n    /**\r\n     * コントローラー準備\r\n     */\r\n    createControl() {\r\n        const app = gradioApp();\r\n        this.foreverBtn = app.querySelector(`#d2gf-forever-btn_${this.type}`) as HTMLButtonElement;\r\n        this.foreverBtn.addEventListener('click', () => {\r\n            this.startGenerateForever();\r\n        });\r\n\r\n        this.cancelBtn = app.querySelector(`#d2gf-cancel-btn_${this.type}`) as HTMLButtonElement;\r\n        this.cancelBtn.addEventListener('click', () => {\r\n            this.cancelForever();\r\n        });\r\n\r\n        // カウント表示エリア\r\n        const countContainer = this.counter.createContainer();\r\n        this.counter.resetCount();\r\n\r\n        // 機能拡張エリアの枠を生成ボタンの下に移動しちゃう\r\n        const actionColumn = app.getElementById(`${this.type}_actions_column`) as HTMLElement;\r\n        const generateBox = app.getElementById(`${this.type}_generate_box`) as HTMLButtonElement;\r\n        const container = document.createElement('div');\r\n        container.classList.add('d2gf-action-container');\r\n        container.appendChild(this.foreverBtn);\r\n        container.appendChild(this.cancelBtn);\r\n        container.appendChild(countContainer);\r\n        actionColumn.insertBefore(container, generateBox.nextSibling);\r\n\r\n        // シード入力欄\r\n        const seedInput = app.querySelector(`#${this.type}_seed input`) as HTMLInputElement;\r\n\r\n        // シードとバッチカウントを定期的にチェック\r\n        setInterval(() => {\r\n            this.changeState('seed', seedInput.value !== '-1' ? 'fix' : 'random');\r\n            this.counter.getBatchCount();\r\n        }, SEED_INTERVAL);\r\n    }\r\n\r\n    /**\r\n     * 状態変更\r\n     */\r\n    changeState(stateAttr: TStateAttr, state: TStateVal) {\r\n        const foreverBtn = this.foreverBtn as HTMLButtonElement;\r\n        const cancelBtn = this.cancelBtn as HTMLButtonElement;\r\n\r\n        this.state[stateAttr] = state;\r\n        foreverBtn.setAttribute(`data-${stateAttr}`, state);\r\n        cancelBtn.setAttribute(`data-${stateAttr}`, state);\r\n    }\r\n\r\n    // webui自体のタイトル変更に影響があるので実装見送り\r\n    // /**\r\n    //  * ページタイトルを変更\r\n    //  */\r\n    // setTitle(count: number = 0, batchCount: string = '') {\r\n    //     if (count) {\r\n    //         document.title = `${this.pageTitle} - [${count} / ${batchCount}]`;\r\n    //     } else {\r\n    //         document.title = this.pageTitle;\r\n    //     }\r\n    // }\r\n\r\n    /**\r\n     * 無限生成停止\r\n     */\r\n    cancelForever() {\r\n        this.changeState('forever', 'stop');\r\n        // this.setTitle();\r\n    }\r\n\r\n    /**\r\n     * 無限生成開始\r\n     */\r\n    startGenerateForever() {\r\n        this.counter.resetCount();\r\n        this.changeState('forever', 'forever');\r\n        this.generateForever();\r\n    }\r\n\r\n    /**\r\n     * 無限生成\r\n     */\r\n    generateForever() {\r\n        const interruptBtn = gradioApp().querySelector(`#${this.type}_interrupt`) as HTMLButtonElement;\r\n        const generateBtn = gradioApp().querySelector(`#${this.type}_generate`) as HTMLButtonElement;\r\n\r\n        // 中止ボタンが非表示の時だけ押せる\r\n        if (interruptBtn.offsetParent === null && this.state.forever === 'forever') {\r\n            generateBtn.click();\r\n            this.counter.addCount();\r\n            // this.setTitle(this.counter.count, this.counter.batchCountText);\r\n        }\r\n\r\n        if (this.counter.getBatchCount() > 1 && this.counter.count >= this.counter.getBatchCount()) {\r\n            // 指定数に達したら終了\r\n            this.cancelForever();\r\n        } else if (this.state.forever === 'forever') {\r\n            // ランダム時間待機して再実行\r\n            const waitBase = parseInt(opts.d2_gs_wait_base);\r\n            const waitRange = parseInt(opts.d2_gs_wait_range);\r\n            const waitTime = (Math.random() * waitRange + waitBase) * 1000;\r\n            setTimeout(() => {\r\n                this.generateForever();\r\n            }, waitTime);\r\n        }\r\n    }\r\n}\r\n\r\nexport { D2GFGenerateForever };\r\n","declare var onUiLoaded: any;\r\n\r\nimport { D2GFGenerateForever } from './D2GFGenerateForever';\r\n\r\n/////////////////////////////\r\n/////////////////////////////\r\n// UI表示したら作成\r\nonUiLoaded(() => {\r\n    const d2gf_t2i = new D2GFGenerateForever('txt2img');\r\n    const d2gf_i2i = new D2GFGenerateForever('img2img');\r\n\r\n    d2gf_t2i.init();\r\n    d2gf_i2i.init();\r\n});\r\n"],"names":[],"mappings":";;;AAKA,MAAM,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAcd,YAAY,MAAa;AAbzB;AACA;AACA;AACA;AACA,0CAAyB;AACzB,iCAAQ;AASJ,SAAK,OAAO;AAAA,EAChB;AAAA,EAEA,kBAA+B;AAC3B,UAAM,MAAM;AAEN,UAAA,YAAY,SAAS,cAAc,MAAM;AACrC,cAAA,KAAK,wBAAwB,KAAK,IAAI;AAE3C,SAAA,YAAY,SAAS,cAAc,MAAM;AACzC,SAAA,UAAU,UAAU,IAAI,iBAAiB;AAEzC,SAAA,YAAY,SAAS,cAAc,MAAM;AACpC,cAAA,YAAY,KAAK,SAAS;AAC1B,cAAA,YAAY,KAAK,SAAS;AAGpC,SAAK,kBAAkB,IAAI,cAAc,IAAI,KAAK,IAAI,oBAAoB;AAEnE,WAAA;AAAA,EACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,gBAAwB;AACpB,UAAM,kBAAkB,KAAK;AAC7B,QAAI,KAAK,WAAW;AAChB,WAAK,iBAAiB,GAAG,gBAAgB,UAAU,MAAM,MAAM,gBAAgB,KAAK;AAC/E,WAAA,UAAU,cAAc,KAAK;AAAA,IACtC;AACO,WAAA,SAAS,gBAAgB,KAAK;AAAA,EACzC;AAAA,EAEA,aAAa;AACT,SAAK,WAAW,CAAC;AAAA,EACrB;AAAA,EAEA,WAAW;AACF,SAAA,WAAW,KAAK,QAAQ,CAAC;AAAA,EAClC;AAAA;AAAA;AAAA;AAAA,EAKQ,WAAW,OAAe;AAC9B,SAAK,QAAQ;AAEb,QAAI,KAAK,WAAW;AACX,WAAA,UAAU,cAAc,GAAG,KAAK;AAAA,IACzC;AAAA,EACJ;AACJ;ACpEA,MAAM,gBAAgB;AAEtB,MAAM,oBAAoB;AAAA;AAAA;AAAA;AAAA;AAAA,EActB,YAAY,MAAa;AAbzB;AACA;AAEA;AACA;AACA;AACA,yCAAgB;AAChB;AAOI,SAAK,OAAO;AACZ,SAAK,QAAQ;AAAA,MACT,SAAS;AAAA,MACT,MAAM;AAAA,IAAA;AAEV,SAAK,gBAAgB;AAChB,SAAA,UAAU,IAAI,YAAY,IAAI;AACnC,SAAK,YAAY,SAAS;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAKA,OAAO;AACH,SAAK,cAAc;AAAA,EACvB;AAAA;AAAA;AAAA;AAAA,EAKA,gBAAgB;AACZ,UAAM,MAAM;AACZ,SAAK,aAAa,IAAI,cAAc,qBAAqB,KAAK,IAAI,EAAE;AAC/D,SAAA,WAAW,iBAAiB,SAAS,MAAM;AAC5C,WAAK,qBAAqB;AAAA,IAAA,CAC7B;AAED,SAAK,YAAY,IAAI,cAAc,oBAAoB,KAAK,IAAI,EAAE;AAC7D,SAAA,UAAU,iBAAiB,SAAS,MAAM;AAC3C,WAAK,cAAc;AAAA,IAAA,CACtB;AAGK,UAAA,iBAAiB,KAAK,QAAQ,gBAAgB;AACpD,SAAK,QAAQ;AAGb,UAAM,eAAe,IAAI,eAAe,GAAG,KAAK,IAAI,iBAAiB;AACrE,UAAM,cAAc,IAAI,eAAe,GAAG,KAAK,IAAI,eAAe;AAC5D,UAAA,YAAY,SAAS,cAAc,KAAK;AACpC,cAAA,UAAU,IAAI,uBAAuB;AACrC,cAAA,YAAY,KAAK,UAAU;AAC3B,cAAA,YAAY,KAAK,SAAS;AACpC,cAAU,YAAY,cAAc;AACvB,iBAAA,aAAa,WAAW,YAAY,WAAW;AAG5D,UAAM,YAAY,IAAI,cAAc,IAAI,KAAK,IAAI,aAAa;AAG9D,gBAAY,MAAM;AACd,WAAK,YAAY,QAAQ,UAAU,UAAU,OAAO,QAAQ,QAAQ;AACpE,WAAK,QAAQ;OACd,aAAa;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,YAAY,WAAuB,OAAkB;AACjD,UAAM,aAAa,KAAK;AACxB,UAAM,YAAY,KAAK;AAElB,SAAA,MAAM,SAAS,IAAI;AACxB,eAAW,aAAa,QAAQ,SAAS,IAAI,KAAK;AAClD,cAAU,aAAa,QAAQ,SAAS,IAAI,KAAK;AAAA,EACrD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAiBA,gBAAgB;AACP,SAAA,YAAY,WAAW,MAAM;AAAA,EAEtC;AAAA;AAAA;AAAA;AAAA,EAKA,uBAAuB;AACnB,SAAK,QAAQ;AACR,SAAA,YAAY,WAAW,SAAS;AACrC,SAAK,gBAAgB;AAAA,EACzB;AAAA;AAAA;AAAA;AAAA,EAKA,kBAAkB;AACd,UAAM,eAAe,UAAU,EAAE,cAAc,IAAI,KAAK,IAAI,YAAY;AACxE,UAAM,cAAc,UAAU,EAAE,cAAc,IAAI,KAAK,IAAI,WAAW;AAGtE,QAAI,aAAa,iBAAiB,QAAQ,KAAK,MAAM,YAAY,WAAW;AACxE,kBAAY,MAAM;AAClB,WAAK,QAAQ;IAEjB;AAEI,QAAA,KAAK,QAAQ,cAAA,IAAkB,KAAK,KAAK,QAAQ,SAAS,KAAK,QAAQ,cAAA,GAAiB;AAExF,WAAK,cAAc;AAAA,IACZ,WAAA,KAAK,MAAM,YAAY,WAAW;AAEnC,YAAA,WAAW,SAAS,KAAK,eAAe;AACxC,YAAA,YAAY,SAAS,KAAK,gBAAgB;AAChD,YAAM,YAAY,KAAK,OAAO,IAAI,YAAY,YAAY;AAC1D,iBAAW,MAAM;AACb,aAAK,gBAAgB;AAAA,SACtB,QAAQ;AAAA,IACf;AAAA,EACJ;AACJ;AC7IA,WAAW,MAAM;AACP,QAAA,WAAW,IAAI,oBAAoB,SAAS;AAC5C,QAAA,WAAW,IAAI,oBAAoB,SAAS;AAElD,WAAS,KAAK;AACd,WAAS,KAAK;AAClB,CAAC;"}